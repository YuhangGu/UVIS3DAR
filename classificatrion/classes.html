<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>3D Flow Map</title>
    <!-- D3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <!-- Tween -->
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript">
    classificationBreakPoint();

    function classificationBreakPoint() {

        var widthWindow = 1200,
            height = 700;


        d3.json("data.json").then(function(data) {

            var classes = [
                [41, 121, 318],
                [27, 89, 205],
                [25, 74, 187],
            ];



            data.forEach(function(sub, k) {


                var width = widthWindow / 3 - 5;

                var svg = d3.select("#map").append('svg')
                    .attr("width", width).attr('height', height)
                    .attr('transform', function(d) {
                        return "translate(" + 30 * k + "," + 0 + ")";
                    });


                var arr = [].concat(...sub.arr);

                arr = arr.filter(function(d) {
                    return d > 0;
                })

                arr = arr.sort(function(a, b) { return a - b });


                //var set = d3.set(arr_raw);

                //var arr = set.values().map(d => parseInt(d));

                var x = d3.scaleLinear()
                    .domain([1, arr.length])
                    .range([2, width]);

                var y = d3.scaleLinear()
                    .domain(d3.extent(arr))
                    .range([height - 2, 3])

                svg.append("g")
                    .selectAll('.bars')
                    .data(arr)
                    .enter()
                    .append("rect")
                    .attr("class", "bars")
                    .attr("x", (d, i) => x(i))
                    .attr("width", width / arr.length)
                    .attr("y", function(d) {
                        return y(d)
                    })
                    .attr("height", function(d) {
                        return height - y(d)
                    })
                    .attr('fill', 'steelblue')
                    .on('mouseover', function(d) {
                        d3.select('.labelhover' + k)
                            .text(d)
                    })
                    .on('mouseout', function(d) {
                        d3.select('.labelhover' + k)
                            .text('')
                    });


                svg.append("g")
                    .selectAll('.marklines')
                    .data(classes[k])
                    .enter()
                    .append("line")
                    .attr('stroke', 'red')
                    .attr("class", "marklines")
                    .attr("x2", 0)
                    .attr("y2", d => y(d))
                    .attr("x1", d => x(arr.indexOf(d)))
                    .attr("y1", d => y(d))

                svg.append("g")
                    .selectAll('.marklines')
                    .data(classes[k])
                    .enter()
                    .append("line")
                    .attr('stroke', 'red')
                    .attr("class", "marklines")
                    .attr("x2", d => x(arr.indexOf(d)))
                    .attr("y2", d => y(d))
                    .attr("x1", d => x(arr.indexOf(d)))
                    .attr("y1", height)


                svg.append("g")
                    .selectAll('.label')
                    .data(classes[k])
                    .enter()
                    .append("text")
                    .attr('class', 'label')
                    .text(d => d)
                    .attr("x", x(arr.length) / 2)
                    .attr("y", d => y(d) + 10)
                    .attr("dy", ".35em");

                


                svg.append("text")
                    .attr('class', 'name')
                    .attr("x", x(arr.length) / 2)
                    .attr("y", 30)
                    .attr("dy", ".35em")
                    .text(sub.name)

                    svg.append("text")
                    .attr('class', 'labelhover' + k)
                    .attr("x", x(arr.length) / 2)
                    .attr("y", 100)
                    .attr("dy", ".35em")





            });
        });

    }

    function createClass3() {

        var width = 1200,
            height = 600;
        var svg = d3.select("#map").append('svg')
            .attr("width", width).attr('height', height);
        var x = d3.scaleLinear()
            .domain([0, 2])
            .range([40, width - 400])
        d3.json("data.json").then(function(data) {
            data.forEach(function(sub, i) {

                var arr = [].concat(...sub.arr);

                arr = arr.filter(function(d) {
                    return d > 0;
                })

                arr = arr.sort(function(a, b) { return a - b });



                if (i == 1) {
                    console.log(arr);
                    console.log(classB);

                    var divider = parseInt(arr.length / 4);
                    console.log(divider, divider * 4);

                    console.log(arr.slice(0, divider));
                    console.log(arr.slice(divider, 2 * divider));
                    console.log(arr.slice(2 * divider, 3 * divider));
                    console.log(arr.slice(3 * divider));


                }


                var y = d3.scaleLinear()
                    .domain(d3.extent(arr))
                    .range([height - 30, 30])
                svg.append("g")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("fill", "none")
                    .selectAll("circle")
                    .data(arr)
                    .join("circle")
                    .attr("cx", x(i))
                    .attr("cy", d => y(d))
                    .attr("r", 2);
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(arr)
                    .join("text")
                    .attr('text-anchor', "end")
                    .attr("x", x(i) - 10)
                    .attr("y", d => y(d))
                    .text(d => d);
                var gT = svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 15)
                    .attr('text-anchor', "middle");
                gT.append('text')
                    .attr("x", x(i))
                    .attr("y", y.range()[0] + 20)
                    .text(sub.name);
                var extent = d3.extent(arr);
                var dist = extent[1] - extent[0];
                var classA = [0, extent[0] + dist / 4, extent[0] + dist / 2, extent[0] + 3 * dist / 4, extent[0] + dist];
                var classB = [0, d3.quantile(arr, 0.25), d3.quantile(arr, 0.5), d3.quantile(arr, 0.5), d3.quantile(arr, 1)]
                var mean = d3.mean(arr);
                var arr_left = arr.filter(function(d) { return d <= mean });
                var arr_right = arr.filter(function(d) { return d > mean });
                var mean_left = d3.mean(arr_left);
                var mean_right = d3.mean(arr_right);
                //console.log(arr, arr_left, arr_right)
                var classC = [0, mean_left, mean, mean_right, extent[1]];




                svg.append("g")
                    .attr("stroke", "red")
                    .attr("stroke-width", 1.5)
                    .attr("fill", "none")
                    .selectAll("circle")
                    .data(classA)
                    .join("circle")
                    .attr("cx", x(i) + 20)
                    .attr("cy", d => y(d))
                    .attr("r", 3);
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classA)
                    .join("text")
                    .attr('fill', "red")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 20)
                    .attr("y", d => y(d))
                    .text(function(d, i) {
                        if (i == 0) return null;
                        return "class" + i + ": " + parseInt(d)
                    });
                var lineA = line = d3.line()
                    .x(function(d) { return x(i) + 20 })
                    .y(function(d) { return y(d) })
                    .curve(d3.curveMonotoneX);
                svg.append("path")
                    .datum(classA)
                    .attr("class", "line")
                    .attr("d", lineA)
                    .attr("stroke", 'red')
                    .attr("stroke-width", 1);
                // class B
                svg.append("g")
                    .attr("stroke", "green")
                    .attr("stroke-width", 1.5)
                    .attr("fill", "none")
                    .selectAll("circle")
                    .data(classB)
                    .join("circle")
                    .attr("cx", x(i) + 90)
                    .attr("cy", d => y(d))
                    .attr("r", 3);
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classB)
                    .join("text")
                    .attr('fill', "green")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 90)
                    .attr("y", d => y(d))
                    .text(function(d, i) {
                        if (i == 0) return null;
                        return "class" + i + ": " + parseInt(d)
                    });
                var lineB = line = d3.line()
                    .x(function(d) { return x(i) + 90 })
                    .y(function(d) { return y(d) })
                    .curve(d3.curveMonotoneX);
                svg.append("path")
                    .datum(classB)
                    .attr("class", "line")
                    .attr("d", lineB)
                    .attr("stroke", 'green')
                    .attr("stroke-width", 1);
                // class c
                svg.append("g")
                    .attr("stroke", "#6600CC")
                    .attr("stroke-width", 1.5)
                    .attr("fill", "none")
                    .selectAll("circle")
                    .data(classC)
                    .join("circle")
                    .attr("cx", x(i) + 160)
                    .attr("cy", d => y(d))
                    .attr("r", 3);
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classC)
                    .join("text")
                    .attr('fill', "#6600CC")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 160)
                    .attr("y", d => y(d))
                    .text(function(d, i) {
                        if (i == 0) return null;
                        return "class" + i + ": " + parseInt(d)
                    });
                var lineC = line = d3.line()
                    .x(function(d) { return x(i) + 160 })
                    .y(function(d) { return y(d) })
                    .curve(d3.curveMonotoneX);
                svg.append("path")
                    .datum(classC)
                    .attr("class", "line")
                    .attr("d", lineC)
                    .attr("stroke", '#6600CC')
                    .attr("stroke-width", 1);
                //
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classA)
                    .join("text")
                    .attr('fill', "#000000")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 20)
                    .attr("y", (d, i) => {
                        if (i == 0) return null;
                        return y(d3.mean([classA[i - 1], classA[i]]))
                    })
                    .text(function(d, i) {
                        if (i == 0) return null;
                        var tempArr = arr.filter(function(t) {
                            return t > classA[i - 1] && t <= classA[i]
                        })
                        return tempArr.length + " flows"
                    });
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classB)
                    .join("text")
                    .attr('fill', "#000000")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 90)
                    .attr("y", (d, i) => {
                        if (i == 0) return null;
                        return y(d3.mean([classB[i - 1], classB[i]]))
                    })
                    .text(function(d, i) {
                        if (i == 0) return null;
                        var tempArr = arr.filter(function(t) {
                            return t > classB[i - 1] && t <= classB[i]
                        })
                        return tempArr.length + " flows"
                    });
                svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(classC)
                    .join("text")
                    .attr('fill', "#000000")
                    .attr('text-anchor', "start")
                    .attr("x", x(i) + 10 + 160)
                    .attr("y", (d, i) => {
                        if (i == 0) return null;
                        return y(d3.mean([classC[i - 1], classC[i]]))
                    })
                    .text(function(d, i) {
                        if (i == 0) return null;
                        var tempArr = arr.filter(function(t) {
                            return t > classC[i - 1] && t <= classC[i]
                        })
                        return tempArr.length + " flows"
                    });



            });
        });
    }
    </script>
</body>

</html>