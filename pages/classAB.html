<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>3D Flow Map</title>
    <!-- D3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <!-- Tween -->
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript">
    var width = 1200,
        height = 600;

    var svg = d3.select("#map").append('svg')
        .attr("width", width).attr('height', height);


    var x = d3.scaleLinear()
        .domain([0, 2])
        .range([40, width - 400])


    d3.json("data.json").then(function(data) {



        data.forEach(function(sub, i) {


            var y = d3.scaleLinear()
                .domain(d3.extent(sub.arr))
                .range([height - 30, 30])

            svg.append("g")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(sub.arr)
                .join("circle")
                .attr("cx", x(i))
                .attr("cy", d => y(d))
                .attr("r", 2);

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(sub.arr)
                .join("text")
                .attr('text-anchor', "end")
                .attr("x", x(i) - 10)
                .attr("y", d => y(d))
                .text(d => d);


            var gT = svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 15)
                .attr('text-anchor', "middle");


            gT.append('text')
                .attr("x", x(i))
                .attr("y", y.range()[0] + 20)
                .text(sub.name);


            var extent = d3.extent(sub.arr);

            var dist = extent[1] - extent[0];

            var classA = [0, extent[0] + dist / 4, extent[0] + dist / 2, extent[0] + 3 * dist / 4, extent[0] + dist];


            var classB = [0, d3.quantile(sub.arr, 0.25), d3.quantile(sub.arr, 0.5), d3.quantile(sub.arr, 0.5), d3.quantile(sub.arr, 1)]

            var mean = d3.mean(sub.arr);
            var arr_left = sub.arr.filter(function(d) { return d <= mean });
            var arr_right = sub.arr.filter(function(d) { return d > mean });
            var mean_left = d3.mean(arr_left);
            var mean_right = d3.mean(arr_right);

            //console.log(sub.arr, arr_left, arr_right)
            var classC = [0, mean_left, mean, mean_right, extent[1]];

            svg.append("g")
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(classA)
                .join("circle")
                .attr("cx", x(i) + 20)
                .attr("cy", d => y(d))
                .attr("r", 3);

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classA)
                .join("text")
                .attr('fill', "red")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 20)
                .attr("y", d => y(d))
                .text(function(d, i) {
                    if (i == 0) return null;
                    return "class" + i + ": " + parseInt(d)
                });

            var lineA = line = d3.line()
                .x(function(d) { return x(i) + 20 })
                .y(function(d) { return y(d) })
                .curve(d3.curveMonotoneX);


            svg.append("path")
                .datum(classA)
                .attr("class", "line")
                .attr("d", lineA)
                .attr("stroke", 'red')
                .attr("stroke-width", 1);



            // class B
            svg.append("g")
                .attr("stroke", "green")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(classB)
                .join("circle")
                .attr("cx", x(i) + 90)
                .attr("cy", d => y(d))
                .attr("r", 3);

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classB)
                .join("text")
                .attr('fill', "green")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 90)
                .attr("y", d => y(d))
                .text(function(d, i) {
                    if (i == 0) return null;
                    return "class" + i + ": " + parseInt(d)
                });


            var lineB = line = d3.line()
                .x(function(d) { return x(i) + 90 })
                .y(function(d) { return y(d) })
                .curve(d3.curveMonotoneX);


            svg.append("path")
                .datum(classB)
                .attr("class", "line")
                .attr("d", lineB)
                .attr("stroke", 'green')
                .attr("stroke-width", 1);


            // class c
            svg.append("g")
                .attr("stroke", "#6600CC")
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(classC)
                .join("circle")
                .attr("cx", x(i) + 160)
                .attr("cy", d => y(d))
                .attr("r", 3);

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classC)
                .join("text")
                .attr('fill', "#6600CC")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 160)
                .attr("y", d => y(d))
                .text(function(d, i) {
                    if (i == 0) return null;
                    return "class" + i + ": " + parseInt(d)
                });


            var lineC = line = d3.line()
                .x(function(d) { return x(i) + 160 })
                .y(function(d) { return y(d) })
                .curve(d3.curveMonotoneX);

            svg.append("path")
                .datum(classC)
                .attr("class", "line")
                .attr("d", lineC)
                .attr("stroke", '#6600CC')
                .attr("stroke-width", 1);




            //
            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classA)
                .join("text")
                .attr('fill', "#000000")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 20)
                .attr("y", (d, i) => {
                    if (i == 0) return null;
                    return y(d3.mean([classA[i - 1], classA[i]]))
                })
                .text(function(d, i) {
                    if (i == 0) return null;

                    var tempArr = sub.arr.filter(function(t) {
                        return t > classA[i - 1] && t <= classA[i]
                    })
                    return tempArr.length + " flows"
                });

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classB)
                .join("text")
                .attr('fill', "#000000")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 90)
                .attr("y", (d, i) => {
                    if (i == 0) return null;
                    return y(d3.mean([classB[i - 1], classB[i]]))
                })
                .text(function(d, i) {
                    if (i == 0) return null;

                    var tempArr = sub.arr.filter(function(t) {
                        return t > classB[i - 1] && t <= classB[i]
                    })
                    return tempArr.length + " flows"
                });

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .selectAll("text")
                .data(classC)
                .join("text")
                .attr('fill', "#000000")
                .attr('text-anchor', "start")
                .attr("x", x(i) + 10 + 160)
                .attr("y", (d, i) => {
                    if (i == 0) return null;
                    return y(d3.mean([classC[i - 1], classC[i]]))
                })
                .text(function(d, i) {
                    if (i == 0) return null;

                    var tempArr = sub.arr.filter(function(t) {
                        return t > classC[i - 1] && t <= classC[i]
                    })
                    return tempArr.length + " flows"
                });








        });

    });
    </script>
</body>

</html>